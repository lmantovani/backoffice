{% extends "base.html" %}

{% block title %}Pedidos de Compra - BackOffice{% endblock %}

{% block content %}
<div class="py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="h4">Pedidos de Compra</h2>
      <p class="text-muted mb-0">Crie e acompanhe pedidos integrados ao Omie.</p>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      <strong>Novo Pedido de Compra</strong>
    </div>
    <div class="card-body">
      <form id="purchaseOrderForm" method="post">
        {% csrf_token %}
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Código Integração (opcional)</label>
            <input type="text" name="cCodIntPed" class="form-control" placeholder="PO-0001">
          </div>
          <div class="col-md-4">
          <label class="form-label">Código Fornecedor (Omie)</label>
          <input
              type="text"
              name="codigo_cliente_fornecedor"
              id="supplier-input"
              class="form-control"
              list="suppliers-list"
              autocomplete="off"
              required
          >
          <datalist id="suppliers-list"></datalist>
          <small class="text-muted">
            Comece a digitar o nome, CNPJ ou código para buscar no Omie.
          </small>
        </div>

          <div class="col-md-4">
            <label class="form-label">Valor Total</label>
            <input type="number" step="0.01" name="nValorTotal" class="form-control" required>
          </div>
        </div>

        <div class="row g-3 mt-2">
          <div class="col-md-12">
            <label class="form-label">Observações</label>
            <textarea name="observacao" class="form-control" rows="2"></textarea>
          </div>
        </div>

        <div class="row g-3 mt-2">
          <div class="col-md-12">
            <label class="form-label">Anexos (PDF, XML, etc.)</label>
            <input type="file" name="anexos" class="form-control" multiple>
          </div>
        </div>

        <div class="mt-3 d-flex justify-content-end">
          <button type="submit" class="btn btn-primary">Criar pedido e enviar para Omie</button>
        </div>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <strong>Pedidos integrados</strong>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table mb-0" id="ordersTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Cod.Int.</th>
              <th>nCodPed Omie</th>
              <th>Origem</th>
              <th>Método</th>
              <th>Criado em</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  const form = document.getElementById("purchaseOrderForm");
  const tableBody = document.querySelector("#ordersTable tbody");

  // ------- Autocomplete de fornecedores (Omie) -------
  const supplierInput = document.getElementById("supplier-input");
  const supplierList = document.getElementById("suppliers-list");
  let supplierTimer = null;

  if (supplierInput && supplierList) {
    supplierInput.addEventListener("input", function () {
      const term = this.value.trim();

      // só busca a partir de 3 caracteres
      if (term.length < 3) {
        supplierList.innerHTML = "";
        return;
      }

      clearTimeout(supplierTimer);
      supplierTimer = setTimeout(() => {
        fetch(`/api/suppliers/?search=${encodeURIComponent(term)}`)
          .then((r) => r.json())
          .then((data) => {
            supplierList.innerHTML = "";
            data.forEach((s) => {
              const opt = document.createElement("option");
              // value = código Omie, label = descrição bonita
              opt.value = s.id;
              opt.label = `${s.id} - ${s.nome}${s.cnpj_cpf ? " (" + s.cnpj_cpf + ")" : ""}`;
              supplierList.appendChild(opt);
            });
          })
          .catch((err) => {
            console.error("Erro ao buscar fornecedores:", err);
          });
      }, 300); // debounce de 300ms
    });
  }

  // ------- Lista pedidos integrados -------
  fetch("/api/purchase-orders/integrations/")
    .then(r => r.json())
    .then(data => {
      (data.results || []).forEach(po => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${po.id}</td>
          <td>${po.cod_int_pedido || ""}</td>
          <td>${po.ncodped_omie}</td>
          <td>${po.origem}</td>
          <td>${po.metodo_criacao}</td>
          <td>${po.created_at || ""}</td>
        `;
        tableBody.appendChild(tr);
      });
    });

  // ------- Cria pedido chamando nosso endpoint full-flow -------
  form.addEventListener("submit", async function(e) {
    e.preventDefault();

    const formData = new FormData(form);

    const pedido = {
      cCodIntPed: formData.get("cCodIntPed") || null,
      codigo_cliente_fornecedor: Number(formData.get("codigo_cliente_fornecedor")),
      nValorTotal: parseFloat(formData.get("nValorTotal")),
      observacao: formData.get("observacao") || ""
    };

    const payload = new FormData();
    payload.append("pedido", JSON.stringify(pedido));

    const files = form.querySelector('input[name="anexos"]').files;
    for (let i = 0; i < files.length; i++) {
      payload.append("anexos", files[i]);
    }

    const res = await fetch("/api/purchase-orders/integrations/full-flow/", {
      method: "POST",
      body: payload,
      headers: {
        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    });

    if (res.ok) {
      alert("Pedido criado e enviado para Omie com sucesso!");
      window.location.reload();
    } else {
      const err = await res.text();
      console.error(err);
      alert("Erro ao criar pedido. Veja o console para detalhes.");
    }
  });
});
</script>
{% endblock %}

